
<!DOCTYPE html>
<html lang="en-us">
<head>

  
  <meta charset="UTF-8">
  <title>
    Building redis performance tool with fperf | Shafreeck Sea
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://shafreeck.com/post/fperf/Build-redis-performance-tool-using-fperf/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="http://shafreeck.com/index.xml" rel="alternate" type="application/rss+xml" title="Shafreeck Sea" />
  <link href="http://shafreeck.com/index.xml" rel="feed" type="application/rss+xml" title="Shafreeck Sea" />

  
  
    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="https://ws.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">stLight.options({publisher: '6b8032c5-8647-462a-8e27-c63e9b718c8a', doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://shafreeck.com/">Shafreeck Sea</a></h1>
        <h2>Share Free and Hack, Then you got shafreeck!</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/shafreeck" target="_blank">Twitter</a></li>
          
          <li><a href="https://github.com/shafreeck" target="_blank">GitHub</a></li>
          <li><a href="http://shafreeck.com/index.xml" type="application/rss+xml" target="_blank">RSS</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Building redis performance tool with fperf</h1>
      <div class="meta">
        Jun 18, 2016 &nbsp;
        
          #<a href="/tags/golang">golang</a>&nbsp;
        
          #<a href="/tags/performance">performance</a>&nbsp;
        
          #<a href="/tags/fperf">fperf</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<p><code>fperf</code> is a powerful and flexible framework allows you to build your own
benchmark and load testing tool easily. All the knowledge you should
know is how to send a request and fperf will handle the concurrency and
statistics.</p>

<p>This is an example about how to build a redis benchmark tool with fperf in
3 steps. You can alse build tools for other common servers like mysql, nginx,
memcached or your own servers. Maybe building benchmark tools for private servers
is the most cases you need fperf. In fact, fperf is actually created to benchmark
our grpc servers at first.</p>

<h2 id="coding-3-steps-to-build-a-redis-benchmark-tool:a6cb93323da28c0b4193a54232ad5dee">Coding: 3 steps to build a redis benchmark tool</h2>

<p>You can find the source code from <a href="https://github.com/shafreeck/fperf/blob/master/testcases/redis/redis.go">testcases/redis/redis.go</a></p>

<h3 id="create-the-newclientfunc-https-godoc-org-github-com-shafreeck-fperf-client-newclientfunc-function:a6cb93323da28c0b4193a54232ad5dee">Create the <a href="https://godoc.org/github.com/shafreeck/fperf/client#NewClientFunc">NewClientFunc</a> function</h3>

<pre><code class="language-go">//newRedisClient create the client object. The function should be
//registered to fperf, fperf -h will list all the registered clients(testcases)
func newRedisClient(flag *client.FlagSet) client.Client {
    c := new(redisClient)

    //A client can have itself options. fperf use flag to process
    //the command args and options
    flag.BoolVar(&amp;c.options.verbose, &quot;v&quot;, false, &quot;verbose&quot;)

    //Customize the usage output
    flag.Usage = func() {
        fmt.Printf(&quot;Usage: redis [options] [cmd] [args...]\noptions:\n&quot;)
        flag.PrintDefaults()
    }
    flag.Parse()

    args := flag.Args()
    //Set the default command if not be set
    if len(args) == 0 {
        args = []string{&quot;SET&quot;, &quot;fperf&quot;, &quot;hello world&quot;}
    }
    c.args = args

    if c.options.verbose {
        fmt.Println(c.args)
    }
    return c
}
</code></pre>

<h3 id="implement-dial-and-request-methods:a6cb93323da28c0b4193a54232ad5dee">Implement Dial and Request methods</h3>

<pre><code class="language-go">//Dial to redis server. The addr is set by the fperf option &quot;-server&quot;
func (c *redisClient) Dial(addr string) error {
    rds, err := redis.DialURL(addr)
    if err != nil {
        return err
    }
    c.rds = rds
    return nil
}

//Request send a redis request and return the error if there is
func (c *redisClient) Request() error {
    var args []interface{}

    //Build the redis cmd and args
    cmd := c.args[0]
    for _, arg := range c.args[1:] {
        args = append(args, arg)
    }
    _, err := c.rds.Do(cmd, args...)
    return err
}
</code></pre>

<h3 id="register-to-fperf:a6cb93323da28c0b4193a54232ad5dee">Register to fperf</h3>

<pre><code class="language-go">//Register to fperf
//parameters: name to register, NewClientFunc, a description
func init() {
	client.Register(&quot;redis&quot;, newRedisClient, &quot;redis performance benchmark&quot;)
}
</code></pre>

<h2 id="build-and-run:a6cb93323da28c0b4193a54232ad5dee">Build and Run</h2>

<h3 id="build-your-testcase-using-buildtestcase-sh:a6cb93323da28c0b4193a54232ad5dee">Build your testcase using &ldquo;buildtestcase.sh&rdquo;</h3>

<pre><code class="language-bash">./buildtestcase.sh testcases/redis/
</code></pre>

<h3 id="run-the-benchmark:a6cb93323da28c0b4193a54232ad5dee">Run the benchmark</h3>

<pre><code class="language-bash">./fperf -server redis://localhost:6379 redis hset key field value
2016/04/17 00:04:35 latency 51.447µs qps 18671 total 37343
2016/04/17 00:04:37 latency 33.881µs qps 27777 total 92898
Count: 101781  Min: 16491  Max: 42468733  Avg: 43377.29
------------------------------------------------------------
[     10000,      11000)       0    0.0%    0.0%
[     11000,      13800)       0    0.0%    0.0%
[     13800,      21639)   62151   61.1%   61.1%  ######
[     21639,      43590)   12092   11.9%   72.9%  #
[     43590,     105055)   15539   15.3%   88.2%  ##
[    105055,     277158)   11941   11.7%   99.9%  #
[    277158,     759048)      43    0.0%  100.0%
</code></pre>

<p>See the <a href="https://github.com/shafreeck/fperf/blob/master/docs/quickstart.md">quick start</a> to learn about the output of fperf.</p>

      
      
      
        <div id="share-this" class="col span_10">
          <span class='st_twitter_large' displayText='Tweet'></span>
          <span class='st_facebook_large' displayText='Facebook'></span>
          <span class='st_googleplus_large' displayText='Google +'></span>
          <span class='st_pocket_large' displayText='Pocket'></span>
          <span class='st_sharethis_large' displayText='ShareThis'></span>
          <span class='st_email_large' displayText='Email'></span>  
        </div>
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'shafreeck';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="http://shafreeck.com/post/configo/Use-go-struct-tags-to-correctly-handle-configuration/" rel="prev">Using go struct tags to handle configuration</a></span>
    
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      
      Written by Shafreeck Sea
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-79546556-1', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

